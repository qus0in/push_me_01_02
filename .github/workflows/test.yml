name: Node.js CI + Auto Approve

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  pull_request_target:  # ğŸ”¥ ìë™ ìŠ¹ì¸ì„ ìœ„í•œ ì¶”ê°€ ì´ë²¤íŠ¸
    types: [opened, reopened, synchronize]
  workflow_dispatch:

permissions:
  actions: write
  pull-requests: read
  contents: read  # ì½”ë“œ ì²´í¬ì•„ì›ƒì„ ìœ„í•´ ì¶”ê°€

jobs:
  # ----------------------------------
  # 1. ìë™ ìŠ¹ì¸ ì‘ì—… (ì‹ ê·œ ê¸°ì—¬ììš©)
  # ----------------------------------
  auto-approve:
    if: github.event_name == 'pull_request_target'  # PR ëŒ€ìƒ ì´ë²¤íŠ¸ì—ì„œë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      - name: Approve First-Time Contributors
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          RUN_IDS=$(gh api "/repos/${{ github.repository }}/actions/runs?event=pull_request&pull_request=$PR_NUMBER" --jq '.workflow_runs[] | select(.status == "waiting") | .id')
          for RUN_ID in $RUN_IDS; do
            echo "Approving Run ID: $RUN_ID"
            gh api -X POST "/repos/${{ github.repository }}/actions/runs/$RUN_ID/approve"
          done

  # ----------------------------------
  # 2. ê¸°ì¡´ ë¹Œë“œ/í…ŒìŠ¤íŠ¸ ì‘ì—… (ëª¨ë“  PRì— ì ìš©)
  # ----------------------------------
  build-and-test:
    needs: auto-approve  # ìë™ ìŠ¹ì¸ í›„ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # v3 â†’ v4ë¡œ ì—…ê·¸ë ˆì´ë“œ

      - name: Use Node.js 22.x
        uses: actions/setup-node@v4  # v3 â†’ v4ë¡œ ì—…ê·¸ë ˆì´ë“œ
        with:
          node-version: 22
          cache: 'npm'  # ğŸ”¥ npm ìºì‹± ì¶”ê°€ (ë¹Œë“œ ì†ë„ í–¥ìƒ)

      - name: Install dependencies
        run: npm ci  # npm install â†’ npm cië¡œ ë³€ê²½ (ì •í™•í•œ ë²„ì „ ë³´ì¥)

      - name: Run tests
        run: npm test